<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEIC Part 2 模擬測驗</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8;
            color: #334155;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content flow */
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 900px;
            width: 100%;
            margin-top: 20px; /* Add some margin from the top */
        }
        .question-option {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
        }
        .question-option:hover:not(.disabled) {
            background-color: #e0f2fe;
            border-color: #90cdf4;
        }
        .question-option.selected {
            background-color: #bfdbfe;
            border-color: #60a5fa;
            font-weight: bold;
        }
        .question-option.correct {
            background-color: #d1fae5;
            border-color: #34d399;
            font-weight: bold;
        }
        .question-option.incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
            font-weight: bold;
        }
        .question-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .explanation-section {
            background-color: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none; /* Hidden by default */
            margin-left: auto;
            margin-right: auto;
            text-align: left;
        }
        .explanation-section h3 {
            color: #1e40af;
            margin-bottom: 10px;
        }
        .explanation-section p {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .button-primary, .button-secondary, .button-play-audio, .button-next-part {
            background-color: #3b82f6;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
        }
        .button-primary:hover:not(.disabled) {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .button-secondary {
            background-color: #6b7280;
        }
        .button-secondary:hover:not(.disabled) {
            background-color: #4b5563;
        }
        .button-play-audio {
            background-color: #10b981; /* Green */
        }
        .button-play-audio:hover:not(.disabled) {
            background-color: #059669;
        }
        .button-next-part {
            background-color: #f97316; /* Orange */
        }
        .button-next-part:hover:not(.disabled) {
            background-color: #ea580c;
        }
        .button-primary.disabled, .button-secondary.disabled, .button-play-audio.disabled, .button-next-part.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            width: 100%;
        }
        .question-text-display {
            background-color: #e0f7fa; /* Light blue background for question text */
            border: 1px solid #80deea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-style: italic;
            color: #006064;
            display: none; /* Hidden by default, shown in explanation */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6">TOEIC Part 2 模擬測驗</h1>

        <div id="test-area">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">Part 2: Question-Response (應答問題)</h2>

            <div class="flex justify-between items-center mb-6">
                <span class="text-lg font-semibold text-gray-700">
                    問題 <span id="current-question-number">1</span> / <span id="total-questions">25</span>
                </span>
                <div class="flex gap-2">
                    <button id="play-question-btn" class="button-play-audio">播放問題</button>
                    <button id="play-options-btn" class="button-play-audio">播放選項</button>
                </div>
            </div>

            <!-- Question Text Display (hidden during test, shown in explanation) -->
            <div id="question-text-display" class="question-text-display">
                <p id="question-text-content" class="text-gray-800"></p>
            </div>

            <!-- Options -->
            <div id="options-container" class="mb-8">
                <!-- Options will be dynamically loaded here (radio buttons only during test) -->
            </div>

            <!-- Navigation and Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-6">
                <button id="prev-btn" class="button-secondary" style="display: none;">上一題</button>
                <button id="submit-answer-btn" class="button-primary">提交答案</button>
                <button id="show-explanation-btn" class="button-secondary" style="display: none;">查看詳解</button>
                <button id="next-btn" class="button-primary" style="display: none;">下一題</button>
            </div>

            <!-- Explanation Section -->
            <div id="explanation-display" class="explanation-section">
                <h3 class="text-xl font-bold mb-3">詳解</h3>
                <h4 class="text-lg font-semibold text-blue-800 mb-2">官方解析：</h4>
                <p id="official-explanation" class="text-gray-700 mb-4"></p>
                <h4 class="text-lg font-semibold text-blue-800 mb-2">詞彙補充：</h4>
                <p id="vocabulary-explanation" class="text-gray-700 mb-4"></p>
                <h4 class="text-lg font-semibold text-blue-800 mb-2">選項分析：</h4>
                <p id="analysis-explanation" class="text-gray-700 mb-4"></p>
            </div>

            <!-- Status Message -->
            <div id="status-message" class="status-message" style="display: none;"></div>
        </div>

        <div id="completion-area" class="text-center mt-10 p-8 bg-blue-50 rounded-lg shadow-inner" style="display: none;">
            <h2 class="text-3xl font-bold text-blue-800 mb-4">Part 2 測驗完成！</h2>
            <p class="text-xl text-gray-700 mb-6">您已完成所有 Part 2 題目。</p>
            <button id="next-part-btn" class="button-next-part text-lg px-6 py-3 mr-4">前往 Part 3</button>
            <button id="restart-test-btn" class="button-secondary text-lg px-6 py-3">重新開始 Part 2</button>
        </div>
    </div>

    <script>
        // Global state variables, declared at the top
        let currentQuestionIndex = 0; // Tracks the current question (0-24 for Part 2)
        let userAnswers = new Array(25).fill(null); // Stores user's selected option text, size 25 for Part 2
        let isExplanationMode = false; // Flag to indicate if explanation is being shown
        let speechUtterance = null;
        let isSpeaking = false;
        let currentOptionIndex = 0; // To track which option is being spoken for sequential playback
        let selectedVoice = null; // <--- 新增這一行


        // All TOEIC Part 2 Questions (25 questions)
        const allQuestions = [
            {
                id: "P2-Q01", part: 2, type: "Question-Response",
                questionAudioText: "Excuse me, where is the nearest subway station?",
                optionsAudioText: [
                    "It's about two blocks down.",
                    "I usually take the bus.",
                    "The train leaves at five."
                ],
                correctAnswerText: "It's about two blocks down.",
                explanation: {
                    official: "問題詢問最近的地鐵站在哪裡，選項 A 'It's about two blocks down.' 提供了方向，是正確的回應。",
                    vocabulary: "nearest (最近的), subway station (地鐵站), blocks (街區).",
                    analysis: "選項 B 'I usually take the bus.' 回答了個人習慣而非問題；選項 C 'The train leaves at five.' 提到了火車時間而非地鐵站位置。"
                },
                questionText: "Excuse me, where is the nearest subway station?" // For explanation display
            },
            {
                id: "P2-Q02", part: 2, type: "Question-Response",
                questionAudioText: "When will the new marketing campaign be launched?",
                optionsAudioText: [
                    "It's scheduled for next month.",
                    "The marketing team is very creative.",
                    "I've already bought the product."
                ],
                correctAnswerText: "It's scheduled for next month.",
                explanation: {
                    official: "問題詢問新行銷活動何時啟動，選項 A 'It's scheduled for next month.' 提供了時間資訊，是正確的回應。",
                    vocabulary: "marketing campaign (行銷活動), launched (啟動), scheduled (預定).",
                    analysis: "選項 B 'The marketing team is very creative.' 描述團隊特點而非時間；選項 C 'I've already bought the product.' 回答了個人行為而非活動時間。"
                },
                questionText: "When will the new marketing campaign be launched?"
            },
            {
                id: "P2-Q03", part: 2, type: "Question-Response",
                questionAudioText: "Who is responsible for updating the company website?",
                optionsAudioText: [
                    "I think it's a good website.",
                    "Ms. Lee manages the online content.",
                    "The website was redesigned last year."
                ],
                correctAnswerText: "Ms. Lee manages the online content.",
                explanation: {
                    official: "問題詢問誰負責更新公司網站，選項 B 'Ms. Lee manages the online content.' 指明了負責人，是正確的回應。",
                    vocabulary: "responsible for (負責), updating (更新), manages (管理), online content (線上內容).",
                    analysis: "選項 A 'I think it's a good website.' 評價網站而非負責人；選項 C 'The website was redesigned last year.' 提到了網站歷史而非負責人。"
                },
                questionText: "Who is responsible for updating the company website?"
            },
            {
                id: "P2-Q04", part: 2, type: "Question-Response",
                questionAudioText: "Would you like to have lunch at the cafeteria or order takeout?",
                optionsAudioText: [
                    "I'm not hungry at all.",
                    "Let's just order something in.",
                    "The cafeteria is on the first floor."
                ],
                correctAnswerText: "Let's just order something in.",
                explanation: {
                    official: "問題詢問想在自助餐廳吃午餐還是叫外賣，選項 B 'Let's just order something in.' 表達了叫外賣的意願，是正確的回應。",
                    vocabulary: "cafeteria (自助餐廳), takeout (外賣), order something in (叫外賣).",
                    analysis: "選項 A 'I'm not hungry at all.' 雖然是回應，但沒有從兩個選項中做出選擇；選項 C 'The cafeteria is on the first floor.' 提供了地點而非選擇。"
                },
                questionText: "Would you like to have lunch at the cafeteria or order takeout?"
            },
            {
                id: "P2-Q05", part: 2, type: "Question-Response",
                questionAudioText: "How long does it take to get to the airport by taxi?",
                optionsAudioText: [
                    "It's a very long flight.",
                    "About thirty minutes, depending on traffic.",
                    "The airport is quite far."
                ],
                correctAnswerText: "About thirty minutes, depending on traffic.",
                explanation: {
                    official: "問題詢問搭計程車到機場需要多久，選項 B 'About thirty minutes, depending on traffic.' 提供了時間估計，是正確的回應。",
                    vocabulary: "airport (機場), taxi (計程車), depending on traffic (取決於交通狀況).",
                    analysis: "選項 A 'It's a very long flight.' 回答了飛行時間而非計程車時間；選項 C 'The airport is quite far.' 描述了距離而非具體時間。"
                },
                questionText: "How long does it take to get to the airport by taxi?"
            },
            {
                id: "P2-Q06", part: 2, type: "Question-Response",
                questionAudioText: "Why was the meeting postponed until next week?",
                optionsAudioText: [
                    "Because the main speaker was ill.",
                    "I will attend the meeting.",
                    "The meeting room is on the second floor."
                ],
                correctAnswerText: "Because the main speaker was ill.",
                explanation: {
                    official: "問題詢問會議為何延期，選項 A 'Because the main speaker was ill.' 提供了原因，是正確的回應。",
                    vocabulary: "postponed (延期), main speaker (主要發言人), ill (生病).",
                    analysis: "選項 B 'I will attend the meeting.' 回答了個人行動而非延期原因；選項 C 'The meeting room is on the second floor.' 提供了地點而非延期原因。"
                },
                questionText: "Why was the meeting postponed until next week?"
            },
            {
                id: "P2-Q07", part: 2, type: "Question-Response",
                questionAudioText: "Could you please send me the report by Friday?",
                optionsAudioText: [
                    "I've already sent the email.",
                    "Yes, I can get that done.",
                    "The report is very detailed."
                ],
                correctAnswerText: "Yes, I can get that done.",
                explanation: {
                    official: "問題詢問是否能在週五前發送報告，選項 B 'Yes, I can get that done.' 表示同意並能完成，是正確的回應。",
                    vocabulary: "report (報告), by Friday (在週五前), get that done (完成那件事).",
                    analysis: "選項 A 'I've already sent the email.' 回答了已完成的動作而非對請求的承諾；選項 C 'The report is very detailed.' 描述了報告內容而非對請求的回應。"
                },
                questionText: "Could you please send me the report by Friday?"
            },
            {
                id: "P2-Q08", part: 2, type: "Question-Response",
                questionAudioText: "Didn't you receive the updated project timeline?",
                optionsAudioText: [
                    "Yes, I just checked my inbox.",
                    "The project is going well.",
                    "I'll update the team later."
                ],
                correctAnswerText: "Yes, I just checked my inbox.",
                explanation: {
                    official: "問題詢問是否收到更新的專案時間表，選項 A 'Yes, I just checked my inbox.' 確認收到並提供了時間點，是正確的回應。",
                    vocabulary: "updated (更新的), project timeline (專案時間表), inbox (收件箱).",
                    analysis: "選項 B 'The project is going well.' 描述了專案進度而非是否收到文件；選項 C 'I'll update the team later.' 提到了未來行動而非是否收到文件。"
                },
                questionText: "Didn't you receive the updated project timeline?"
            },
            {
                id: "P2-Q09", part: 2, type: "Question-Response",
                questionAudioText: "How often do you travel for business?",
                optionsAudioText: [
                    "I'm going on a business trip.",
                    "Usually once or twice a month.",
                    "The travel agency is closed today."
                ],
                correctAnswerText: "Usually once or twice a month.",
                explanation: {
                    official: "問題詢問出差頻率，選項 B 'Usually once or twice a month.' 提供了頻率資訊，是正確的回應。",
                    vocabulary: "travel for business (出差), often (經常), once or twice a month (一個月一兩次).",
                    analysis: "選項 A 'I'm going on a business trip.' 描述了單次行動而非頻率；選項 C 'The travel agency is closed today.' 提到了旅行社狀態而非個人頻率。"
                },
                questionText: "How often do you travel for business?"
            },
            {
                id: "P2-Q10", part: 2, type: "Question-Response",
                questionAudioText: "Should I submit the invoice directly to accounting?",
                optionsAudioText: [
                    "Yes, that's the standard procedure.",
                    "The account is overdue.",
                    "I've already submitted the form."
                ],
                correctAnswerText: "Yes, that's the standard procedure.",
                explanation: {
                    official: "問題詢問是否應直接將發票提交給會計部，選項 A 'Yes, that's the standard procedure.' 確認了正確的程序，是正確的回應。",
                    vocabulary: "submit (提交), invoice (發票), accounting (會計部), standard procedure (標準程序).",
                    analysis: "選項 B 'The account is overdue.' 提到了帳戶狀態而非提交程序；選項 C 'I've already submitted the form.' 提到了已完成的動作而非對請求的回應。"
                },
                questionText: "Should I submit the invoice directly to accounting?"
            },
            {
                id: "P2-Q11", part: 2, type: "Question-Response",
                questionAudioText: "Where can I find a good place to have coffee around here?",
                optionsAudioText: [
                    "I prefer tea.",
                    "There's a cafe just around the corner.",
                    "The coffee machine is broken."
                ],
                correctAnswerText: "There's a cafe just around the corner.",
                explanation: {
                    official: "問題詢問附近哪裡有好的咖啡廳，選項 B 'There's a cafe just around the corner.' 提供了地點，是正確的回應。",
                    vocabulary: "good place (好地方), around here (在這附近), cafe (咖啡廳), around the corner (在轉角處).",
                    analysis: "選項 A 'I prefer tea.' 回答了個人偏好而非地點；選項 C 'The coffee machine is broken.' 提到了咖啡機狀態而非地點。"
                },
                questionText: "Where can I find a good place to have coffee around here?"
            },
            {
                id: "P2-Q12", part: 2, type: "Question-Response",
                questionAudioText: "How many copies of the brochure do you need?",
                optionsAudioText: [
                    "I'll copy the document.",
                    "Just twenty should be enough.",
                    "The brochure is very informative."
                ],
                correctAnswerText: "Just twenty should be enough.",
                explanation: {
                    official: "問題詢問需要多少份宣傳冊，選項 B 'Just twenty should be enough.' 提供了具體數量，是正確的回應。",
                    vocabulary: "copies (份數), brochure (宣傳冊), enough (足夠).",
                    analysis: "選項 A 'I'll copy the document.' 提到了動作而非數量；選項 C 'The brochure is very informative.' 描述了宣傳冊內容而非數量。"
                },
                questionText: "How many copies of the brochure do you need?"
            },
            {
                id: "P2-Q13", part: 2, type: "Question-Response",
                questionAudioText: "Isn't Mr. Kim supposed to be giving the presentation today?",
                optionsAudioText: [
                    "No, he's out of town until tomorrow.",
                    "Yes, I enjoyed the presentation.",
                    "The presentation slides are ready."
                ],
                correctAnswerText: "No, he's out of town until tomorrow.",
                explanation: {
                    official: "問題詢問金先生是否今天要做簡報，選項 A 'No, he's out of town until tomorrow.' 否定了並提供了原因，是正確的回應。",
                    vocabulary: "supposed to (應該), presentation (簡報), out of town (出城).",
                    analysis: "選項 B 'Yes, I enjoyed the presentation.' 描述了個人感受而非是否做簡報；選項 C 'The presentation slides are ready.' 提到了簡報準備狀態而非是否做簡報。"
                },
                questionText: "Isn't Mr. Kim supposed to be giving the presentation today?"
            },
            {
                id: "P2-Q14", part: 2, type: "Question-Response",
                questionAudioText: "What's the best way to get to the new office building?",
                optionsAudioText: [
                    "It's a very modern building.",
                    "You can take the express train.",
                    "The office is open until 6 PM."
                ],
                correctAnswerText: "You can take the express train.",
                explanation: {
                    official: "問題詢問去新辦公大樓的最佳方式，選項 B 'You can take the express train.' 提供了交通方式，是正確的回應。",
                    vocabulary: "office building (辦公大樓), express train (特快列車).",
                    analysis: "選項 A 'It's a very modern building.' 描述了建築物特點而非交通方式；選項 C 'The office is open until 6 PM.' 提到了辦公時間而非交通方式。"
                },
                questionText: "What's the best way to get to the new office building?"
            },
            {
                id: "P2-Q15", part: 2, type: "Question-Response",
                questionAudioText: "Could you help me carry these boxes to the storage room?",
                optionsAudioText: [
                    "Sure, I'd be glad to.",
                    "The boxes are very heavy.",
                    "The storage room is locked."
                ],
                correctAnswerText: "Sure, I'd be glad to.",
                explanation: {
                    official: "問題詢問是否能幫忙搬箱子到儲藏室，選項 A 'Sure, I'd be glad to.' 表示樂意提供幫助，是正確的回應。",
                    vocabulary: "carry (搬運), boxes (箱子), storage room (儲藏室), glad to (樂意).",
                    analysis: "選項 B 'The boxes are very heavy.' 描述了箱子狀態而非是否幫忙；選項 C 'The storage room is locked.' 提到了儲藏室狀態而非是否幫忙。"
                },
                questionText: "Could you help me carry these boxes to the storage room?"
            },
            {
                id: "P2-Q16", part: 2, type: "Question-Response",
                questionAudioText: "Did you remember to turn off the lights before you left?",
                optionsAudioText: [
                    "Yes, I turned them off myself.",
                    "The lights are very bright.",
                    "I'll leave soon."
                ],
                correctAnswerText: "Yes, I turned them off myself.",
                explanation: {
                    official: "問題詢問是否記得關燈，選項 A 'Yes, I turned them off myself.' 確認了動作已完成，是正確的回應。",
                    vocabulary: "remember (記得), turn off (關閉), lights (燈), myself (我自己).",
                    analysis: "選項 B 'The lights are very bright.' 描述了燈光特點而非是否關燈；選項 C 'I'll leave soon.' 提到了未來行動而非是否關燈。"
                },
                questionText: "Did you remember to turn off the lights before you left?"
            },
            {
                id: "P2-Q17", part: 2, type: "Question-Response",
                questionAudioText: "Why don't we review the proposal together this afternoon?",
                optionsAudioText: [
                    "That sounds like a good idea.",
                    "The proposal was accepted.",
                    "I'll propose a new plan."
                ],
                correctAnswerText: "That sounds like a good idea.",
                explanation: {
                    official: "問題提議下午一起審查提案，選項 A 'That sounds like a good idea.' 表示贊同提議，是正確的回應。",
                    vocabulary: "review (審查), proposal (提案), together (一起), afternoon (下午).",
                    analysis: "選項 B 'The proposal was accepted.' 提到了提案狀態而非對提議的回應；選項 C 'I'll propose a new plan.' 提到了未來行動而非對提議的回應。"
                },
                questionText: "Why don't we review the proposal together this afternoon?"
            },
            {
                id: "P2-Q18", part: 2, type: "Question-Response",
                questionAudioText: "How much did you pay for the new office chair?",
                optionsAudioText: [
                    "It's very comfortable.",
                    "It cost me about a hundred dollars.",
                    "I bought it online."
                ],
                correctAnswerText: "It cost me about a hundred dollars.",
                explanation: {
                    official: "問題詢問新辦公椅的價格，選項 B 'It cost me about a hundred dollars.' 提供了價格資訊，是正確的回應。",
                    vocabulary: "pay for (支付), office chair (辦公椅), comfortable (舒適的), cost (花費).",
                    analysis: "選項 A 'It's very comfortable.' 描述了椅子特點而非價格；選項 C 'I bought it online.' 提到了購買方式而非價格。"
                },
                questionText: "How much did you pay for the new office chair?"
            },
            {
                id: "P2-Q19", part: 2, type: "Question-Response",
                questionAudioText: "Isn't there a coffee shop on the ground floor?",
                optionsAudioText: [
                    "Yes, it's right next to the lobby.",
                    "I'll have a cup of coffee.",
                    "The coffee is freshly brewed."
                ],
                correctAnswerText: "Yes, it's right next to the lobby.",
                explanation: {
                    official: "問題詢問底樓是否有咖啡店，選項 A 'Yes, it's right next to the lobby.' 確認並提供了地點，是正確的回應。",
                    vocabulary: "coffee shop (咖啡店), ground floor (底樓), lobby (大廳), freshly brewed (新鮮沖泡的).",
                    analysis: "選項 B 'I'll have a cup of coffee.' 提到了個人意願而非地點；選項 C 'The coffee is freshly brewed.' 描述了咖啡狀態而非地點。"
                },
                questionText: "Isn't there a coffee shop on the ground floor?"
            },
            {
                id: "P2-Q20", part: 2, type: "Question-Response",
                questionAudioText: "Who should I contact regarding the software issue?",
                optionsAudioText: [
                    "The software is outdated.",
                    "You should talk to our IT department.",
                    "I've already fixed the problem."
                ],
                correctAnswerText: "You should talk to our IT department.",
                explanation: {
                    official: "問題詢問軟體問題應聯繫誰，選項 B 'You should talk to our IT department.' 提供了聯繫對象，是正確的回應。",
                    vocabulary: "contact (聯繫), software issue (軟體問題), IT department (資訊科技部門), outdated (過時的).",
                    analysis: "選項 A 'The software is outdated.' 描述了軟體狀態而非聯繫對象；選項 C 'I've already fixed the problem.' 提到了已完成的動作而非聯繫對象。"
                },
                questionText: "Who should I contact regarding the software issue?"
            },
            {
                id: "P2-Q21", part: 2, type: "Question-Response",
                questionAudioText: "How long have you been working for this company?",
                optionsAudioText: [
                    "I started here five years ago.",
                    "The company is growing fast.",
                    "I work very hard."
                ],
                correctAnswerText: "I started here five years ago.",
                explanation: {
                    official: "問題詢問為這家公司工作多久了，選項 A 'I started here five years ago.' 提供了工作時間長度，是正確的回應。",
                    vocabulary: "working for (為...工作), company (公司), started (開始).",
                    analysis: "選項 B 'The company is growing fast.' 描述了公司狀態而非工作時間；選項 C 'I work very hard.' 描述了工作態度而非工作時間。"
                },
                questionText: "How long have you been working for this company?"
            },
            {
                id: "P2-Q22", part: 2, type: "Question-Response",
                questionAudioText: "Would you mind closing the window? It's a bit chilly in here.",
                optionsAudioText: [
                    "No, not at all.",
                    "The window is broken.",
                    "It's a beautiful view."
                ],
                correctAnswerText: "No, not at all.",
                explanation: {
                    official: "問題詢問是否介意關窗，選項 A 'No, not at all.' 表示不介意並願意關窗，是正確的回應。",
                    vocabulary: "mind (介意), chilly (寒冷的), not at all (一點也不).",
                    analysis: "選項 B 'The window is broken.' 描述了窗戶狀態而非是否介意；選項 C 'It's a beautiful view.' 描述了景色而非是否介意。"
                },
                questionText: "Would you mind closing the window? It's a bit chilly in here."
            },
            {
                id: "P2-Q23", part: 2, type: "Question-Response",
                questionAudioText: "What's the purpose of your visit today?",
                optionsAudioText: [
                    "I'm here for a job interview.",
                    "The visit was very productive.",
                    "I visited the museum yesterday."
                ],
                correctAnswerText: "I'm here for a job interview.",
                explanation: {
                    official: "問題詢問今天來訪的目的，選項 A 'I'm here for a job interview.' 提供了來訪原因，是正確的回應。",
                    vocabulary: "purpose (目的), visit (來訪), job interview (工作面試), productive (有成效的).",
                    analysis: "選項 B 'The visit was very productive.' 描述了過去訪問的結果而非今天目的；選項 C 'I visited the museum yesterday.' 提到了過去行動而非今天目的。"
                },
                questionText: "What's the purpose of your visit today?"
            },
            {
                id: "P2-Q24", part: 2, type: "Question-Response",
                questionAudioText: "How do you usually commute to work?",
                optionsAudioText: [
                    "I work from home.",
                    "By train, it's faster.",
                    "The commute is very long."
                ],
                correctAnswerText: "By train, it's faster.",
                explanation: {
                    official: "問題詢問通常如何通勤上班，選項 B 'By train, it's faster.' 提供了通勤方式，是正確的回應。",
                    vocabulary: "commute (通勤), usually (通常), train (火車).",
                    analysis: "選項 A 'I work from home.' 描述了工作地點而非通勤方式；選項 C 'The commute is very long.' 描述了通勤時間長度而非方式。"
                },
                questionText: "How do you usually commute to work?"
            },
            {
                id: "P2-Q25", part: 2, type: "Question-Response",
                questionAudioText: "Which of these shirts do you prefer?",
                optionsAudioText: [
                    "I'll take both.",
                    "They are all on sale.",
                    "The shirt is too big."
                ],
                correctAnswerText: "I'll take both.",
                explanation: {
                    official: "問題詢問更喜歡哪件襯衫，選項 A 'I'll take both.' 表達了選擇兩件的意願，是正確的回應。",
                    vocabulary: "prefer (偏好), shirts (襯衫), on sale (特價), too big (太大).",
                    analysis: "選項 B 'They are all on sale.' 描述了商品狀態而非個人偏好；選項 C 'The shirt is too big.' 描述了襯衫尺寸而非偏好。"
                },
                questionText: "Which of these shirts do you prefer?"
            }
        ];

        // DOM Elements (moved up for scope)
        const currentQuestionNumberSpan = document.getElementById('current-question-number');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const playQuestionBtn = document.getElementById('play-question-btn');
        const playOptionsBtn = document.getElementById('play-options-btn');
        const questionTextDisplay = document.getElementById('question-text-display');
        const questionTextContent = document.getElementById('question-text-content');
        const optionsContainer = document.getElementById('options-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');
        const showExplanationBtn = document.getElementById('show-explanation-btn');
        const explanationDisplay = document.getElementById('explanation-display');
        const officialExplanation = document.getElementById('official-explanation');
        const vocabularyExplanation = document.getElementById('vocabulary-explanation');
        const analysisExplanation = document.getElementById('analysis-explanation');
        const statusMessage = document.getElementById('status-message');
        const testArea = document.getElementById('test-area');
        const completionArea = document.getElementById('completion-area');
        const restartTestBtn = document.getElementById('restart-test-btn');
        const nextPartBtn = document.getElementById('next-part-btn'); // New button for next part


        // Initialize total questions display
        totalQuestionsSpan.textContent = allQuestions.length; // Now correctly 25

        // --- Helper to toggle button/option disabled state ---
        function setInteractionState(disabled) {
            const buttons = [playQuestionBtn, playOptionsBtn, submitAnswerBtn, prevBtn, nextBtn, showExplanationBtn, restartTestBtn, nextPartBtn];
            buttons.forEach(btn => {
                if (btn) { // Check if button exists
                    btn.disabled = disabled;
                    btn.classList.toggle('disabled', disabled);
                }
            });
            
            // Logic for options:
            optionsContainer.querySelectorAll('.question-option').forEach(optionDiv => {
                // If we are disabling, always disable options
                if (disabled) {
                    optionDiv.classList.add('disabled');
                    optionDiv.querySelector('input[type="radio"]').disabled = true;
                } else { // If we are enabling
                    // Only enable options if currently in test mode (submit button visible) AND not in explanation mode
                    if (submitAnswerBtn.style.display === 'block' && !isExplanationMode) {
                        optionDiv.classList.remove('disabled');
                        optionDiv.querySelector('input[type="radio"]').disabled = false;
                    } else { // Keep options disabled if submitted or in explanation mode
                        optionDiv.classList.add('disabled');
                        optionDiv.querySelector('input[type="radio"]').disabled = true;
                    }
                }
            });
        }

        // --- Speech Synthesis (TTS) Functionality ---
        // These variables are already declared at the top, so no need to redeclare
        // let speechUtterance = null;
        // let isSpeaking = false;
        // let currentOptionIndex = 0; 

        function speakText(text, onEndCallback = null) {
            if (!('speechSynthesis' in window)) {
                showStatusMessage('您的瀏覽器不支持語音合成功能。', 'error');
                return;
            }

            window.speechSynthesis.cancel(); // Stop any ongoing speech
            setInteractionState(true); // Disable interactions during playback

            speechUtterance = new SpeechSynthesisUtterance(text);
            speechUtterance.lang = 'en-US'; // Set English accent
            if (selectedVoice) { // <--- 新增這一段 if 判斷
                speechUtterance.voice = selectedVoice;
            }

            speechUtterance.onstart = () => {
                isSpeaking = true;
                // Update button text based on which button initiated the speech
                if (text === allQuestions[currentQuestionIndex].questionAudioText) {
                    playQuestionBtn.textContent = '停止播放問題';
                    playQuestionBtn.classList.add('bg-red-500', 'hover:bg-red-700');
                    playQuestionBtn.classList.remove('bg-green-500', 'hover:bg-green-700');
                } else {
                    // This part is for sequential option playback, so currentOptionIndex is relevant
                    playOptionsBtn.textContent = `停止播放選項 (${String.fromCharCode(65 + currentOptionIndex)})`;
                    playOptionsBtn.classList.add('bg-red-500', 'hover:bg-red-700');
                    playOptionsBtn.classList.remove('bg-green-500', 'hover:bg-green-700');
                }
            };

            speechUtterance.onend = () => {
                isSpeaking = false;
                // Reset button text
                playQuestionBtn.textContent = '播放問題';
                playQuestionBtn.classList.remove('bg-red-500', 'hover:bg-red-700');
                playQuestionBtn.classList.add('bg-green-500', 'hover:bg-green-700');

                playOptionsBtn.textContent = '播放選項';
                playOptionsBtn.classList.remove('bg-red-500', 'hover:bg-red-700');
                playOptionsBtn.classList.add('bg-green-500', 'hover:bg-green-700');

                // currentOptionIndex is managed by speakNextOption in playOptionsBtn listener

                if (onEndCallback) {
                    onEndCallback();
                } else {
                    // Re-enable interactions after speech, unless already submitted
                    if (submitAnswerBtn.style.display === 'block') { // If submit button is visible, means not submitted yet
                        setInteractionState(false); // Re-enable all if not submitted
                    } else { // If submitted, re-enable only relevant buttons (options remain disabled)
                        playQuestionBtn.disabled = false; playQuestionBtn.classList.remove('disabled');
                        playOptionsBtn.disabled = false; playOptionsBtn.classList.remove('disabled');
                        prevBtn.disabled = false; prevBtn.classList.remove('disabled');
                        nextBtn.disabled = false; nextBtn.classList.remove('disabled');
                        showExplanationBtn.disabled = false; showExplanationBtn.classList.remove('disabled');
                        restartTestBtn.disabled = false; restartTestBtn.classList.remove('disabled');
                        nextPartBtn.disabled = false; nextPartBtn.classList.remove('disabled');
                    }
                }
            };

            speechUtterance.onerror = (event) => {
                console.error('Speech synthesis error:', event.error);
                showStatusMessage('語音播放失敗，請檢查瀏覽器設定或網路連線。', 'error');
                isSpeaking = false;
                // Reset button text and re-enable interactions on error
                playQuestionBtn.textContent = '播放問題';
                playQuestionBtn.classList.remove('bg-red-500', 'hover:bg-red-700');
                playQuestionBtn.classList.add('bg-green-500', 'hover:bg-green-700');

                playOptionsBtn.textContent = '播放選項';
                playOptionsBtn.classList.remove('bg-red-500', 'hover:bg-red-700');
                playOptionsBtn.classList.add('bg-green-500', 'hover:bg-green-700');
                
                // currentOptionIndex is managed by speakNextOption in playOptionsBtn listener
                
                if (submitAnswerBtn.style.display === 'block') {
                    setInteractionState(false);
                } else {
                    playQuestionBtn.disabled = false; playQuestionBtn.classList.remove('disabled');
                    playOptionsBtn.disabled = false; playOptionsBtn.classList.remove('disabled');
                    prevBtn.disabled = false; prevBtn.classList.remove('disabled');
                    nextBtn.disabled = false; nextBtn.classList.remove('disabled');
                    showExplanationBtn.disabled = false; showExplanationBtn.classList.remove('disabled');
                    restartTestBtn.disabled = false; restartTestBtn.classList.remove('disabled');
                    nextPartBtn.disabled = false; nextPartBtn.classList.remove('disabled');
                }
            };

            window.speechSynthesis.speak(speechUtterance);
        }

        playQuestionBtn.addEventListener('click', () => {
            if (isSpeaking) {
                window.speechSynthesis.cancel();
            } else {
                const currentQuestionData = allQuestions[currentQuestionIndex];
                speakText(currentQuestionData.questionAudioText);
            }
        });

        playOptionsBtn.addEventListener('click', () => {
            if (isSpeaking) {
                window.speechSynthesis.cancel();
            } else {
                const currentQuestionData = allQuestions[currentQuestionIndex];
                const options = currentQuestionData.optionsAudioText;

                const speakNextOption = () => {
                    if (currentOptionIndex < options.length) {
                        const spokenText = `${String.fromCharCode(65 + currentOptionIndex)}. ${options[currentOptionIndex]}`;
                        speakText(spokenText, () => {
                            currentOptionIndex++;
                            speakNextOption(); // Recursive call for next option
                        });
                    } else {
                        // All options spoken, reset state
                        isSpeaking = false;
                        playOptionsBtn.textContent = '播放選項';
                        playOptionsBtn.classList.remove('bg-red-500', 'hover:bg-red-700');
                        playOptionsBtn.classList.add('bg-green-500', 'hover:bg-green-700');
                        currentOptionIndex = 0;
                        if (submitAnswerBtn.style.display === 'block') {
                            setInteractionState(false);
                        } else {
                            playQuestionBtn.disabled = false; playQuestionBtn.classList.remove('disabled');
                            playOptionsBtn.disabled = false; playOptionsBtn.classList.remove('disabled');
                            prevBtn.disabled = false; prevBtn.classList.remove('disabled');
                            nextBtn.disabled = false; nextBtn.classList.remove('disabled');
                            showExplanationBtn.disabled = false; showExplanationBtn.classList.remove('disabled');
                            restartTestBtn.disabled = false; restartTestBtn.classList.remove('disabled');
                            nextPartBtn.disabled = false; nextPartBtn.classList.remove('disabled');
                        }
                    }
                };
                currentOptionIndex = 0; // Start from the first option
                speakNextOption();
            }
        });


        // --- Core Test Logic ---
        function loadQuestion() {
            hideStatusMessage();
            explanationDisplay.style.display = 'none'; // Hide explanation
            showExplanationBtn.style.display = 'none'; // Hide explanation button initially
            submitAnswerBtn.style.display = 'block'; // Show submit button
            setInteractionState(false); // Enable all interactions for new question

            const currentQuestionData = allQuestions[currentQuestionIndex];

            currentQuestionNumberSpan.textContent = currentQuestionIndex + 1;
            questionTextDisplay.style.display = 'none'; // Hide question text during test
            questionTextContent.textContent = ''; // Clear content

            optionsContainer.innerHTML = ''; // Clear previous options

            // For Part 2, only display A, B, C radio buttons without text
            currentQuestionData.optionsAudioText.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('question-option');
                // Value stores the actual option text for comparison, but label only shows A, B, C
                const optionLabelText = `${String.fromCharCode(65 + index)}.`;
                optionDiv.innerHTML = `<input type="radio" name="question-${currentQuestionIndex}" id="option-${currentQuestionIndex}-${index}" value="${option}" class="mr-3 cursor-pointer">
                                       <label for="option-${currentQuestionIndex}-${index}" class="cursor-pointer flex-grow">${optionLabelText}</label>`;
                optionDiv.addEventListener('click', () => {
                    document.querySelectorAll(`#options-container .question-option`).forEach(opt => opt.classList.remove('selected'));
                    optionDiv.classList.add('selected');
                    optionDiv.querySelector('input[type="radio"]').checked = true;
                    userAnswers[currentQuestionIndex] = option; // Store the selected answer text
                });
                optionsContainer.appendChild(optionDiv);
            });

            // Restore user's previous selection if any
            if (userAnswers[currentQuestionIndex] !== null) {
                const selectedOptionValue = userAnswers[currentQuestionIndex];
                const radioInput = optionsContainer.querySelector(`input[value="${selectedOptionValue}"]`);
                if (radioInput) {
                    radioInput.checked = true;
                    radioInput.closest('.question-option').classList.add('selected');
                }
                // If an answer was previously selected, options should remain disabled
                optionsContainer.querySelectorAll('input[type="radio"]').forEach(input => input.disabled = true);
                optionsContainer.querySelectorAll('.question-option').forEach(optionDiv => optionDiv.classList.add('disabled'));
                submitAnswerBtn.style.display = 'none'; // Hide submit button
                showExplanationBtn.style.display = 'block'; // Show explanation button
                nextBtn.style.display = 'block'; // Show next button
            } else {
                // If no answer selected, ensure options are enabled for interaction
                optionsContainer.querySelectorAll('input[type="radio"]').forEach(input => input.disabled = false);
                optionsContainer.querySelectorAll('.question-option').forEach(optionDiv => optionDiv.classList.remove('disabled'));
            }

            // Update navigation button visibility
            prevBtn.style.display = currentQuestionIndex > 0 ? 'block' : 'none';
            nextBtn.style.display = 'none'; // Next button only appears after submission or explanation
        }

        function showStatusMessage(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`; // Reset classes and add new ones
            statusMessage.style.display = 'block';
        }

        function hideStatusMessage() {
            statusMessage.style.display = 'none';
        }

        function submitAnswer() {
            const currentQuestionData = allQuestions[currentQuestionIndex];
            const selectedRadio = optionsContainer.querySelector(`input[name="question-${currentQuestionIndex}"]:checked`);

            if (!selectedRadio) {
                showStatusMessage('請選擇一個答案。', 'error');
                return;
            }

            const userAnswer = selectedRadio.value;
            userAnswers[currentQuestionIndex] = userAnswer; // Store the answer

            // Disable options after submission
            optionsContainer.querySelectorAll('input[type="radio"]').forEach(input => input.disabled = true);
            optionsContainer.querySelectorAll('.question-option').forEach(optionDiv => optionDiv.classList.add('disabled'));

            // Show correct/incorrect feedback
            const optionsDivs = optionsContainer.querySelectorAll('.question-option');
            optionsDivs.forEach(optionDiv => {
                const optionValue = optionDiv.querySelector('input[type="radio"]').value; // Get the actual value
                if (optionValue === currentQuestionData.correctAnswerText) {
                    optionDiv.classList.add('correct');
                } else if (optionValue === userAnswer) {
                    optionDiv.classList.add('incorrect');
                }
            });

            submitAnswerBtn.style.display = 'none'; // Hide submit button
            showExplanationBtn.style.display = 'block'; // Show explanation button
            nextBtn.style.display = 'block'; // Show next button

            if (userAnswer === currentQuestionData.correctAnswerText) {
                showStatusMessage('答案正確！', 'success');
            } else {
                showStatusMessage('答案錯誤。', 'error');
            }
        }

        function showExplanation() {
            isExplanationMode = true;
            const currentQuestionData = allQuestions[currentQuestionIndex];

            // Display question text
            questionTextContent.textContent = currentQuestionData.questionText;
            questionTextDisplay.style.display = 'block';

            // Update options to show full text
            optionsContainer.innerHTML = ''; // Clear and re-render with full text
            currentQuestionData.optionsAudioText.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('question-option', 'disabled'); // Keep disabled in explanation mode
                const optionText = `${String.fromCharCode(65 + index)}. ${option}`;
                optionDiv.innerHTML = `<input type="radio" name="question-${currentQuestionIndex}" id="option-${currentQuestionIndex}-${index}" value="${option}" class="mr-3 cursor-pointer" disabled>
                                       <label for="option-${currentQuestionIndex}-${index}" class="cursor-pointer flex-grow">${optionText}</label>`;
                
                // Apply correct/incorrect styling based on user's answer and correct answer
                if (option === currentQuestionData.correctAnswerText) {
                    optionDiv.classList.add('correct');
                } else if (option === userAnswers[currentQuestionIndex]) {
                    optionDiv.classList.add('incorrect');
                }
                if (option === userAnswers[currentQuestionIndex]) { // Reselect user's choice
                    optionDiv.classList.add('selected');
                    optionDiv.querySelector('input[type="radio"]').checked = true;
                }

                optionsContainer.appendChild(optionDiv);
            });


            // Display explanation details
            officialExplanation.textContent = currentQuestionData.explanation.official;
            vocabularyExplanation.textContent = currentQuestionData.explanation.vocabulary;
            analysisExplanation.textContent = currentQuestionData.explanation.analysis;
            explanationDisplay.style.display = 'block';

            // Hide explanation button after showing
            showExplanationBtn.style.display = 'none';
            nextBtn.style.display = 'block'; // Ensure next button is visible
        }

        function goToNextQuestion() {
            if (currentQuestionIndex < allQuestions.length - 1) {
                currentQuestionIndex++;
                isExplanationMode = false; // Reset mode for next question
                loadQuestion();
            } else {
                // End of test
                testArea.style.display = 'none';
                completionArea.style.display = 'block';
            }
        }

        function goToPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                isExplanationMode = false; // Reset mode for previous question
                loadQuestion();
            }
        }

        function restartTest() {
            currentQuestionIndex = 0;
            userAnswers = new Array(allQuestions.length).fill(null);
            isExplanationMode = false;
            completionArea.style.display = 'none';
            testArea.style.display = 'block';
            loadQuestion();
        }

        // Event Listeners
        nextBtn.addEventListener('click', goToNextQuestion);
        prevBtn.addEventListener('click', goToPreviousQuestion);
        submitAnswerBtn.addEventListener('click', submitAnswer);
        showExplanationBtn.addEventListener('click', showExplanation);
        restartTestBtn.addEventListener('click', restartTest);
        
        // Placeholder for next part button functionality
        nextPartBtn.addEventListener('click', () => {
            // In a real scenario, this would navigate to the Part 3 Canvas URL
            //alert('即將前往 Part 3 測驗！ (此功能待 Part 3 頁面完成後實作)');
             window.location.href = "./part3.html"; // Example navigation

        });

        // --- 新增: 選擇最佳語音的函式 ---
        function selectBestVoice() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return;

            // 定義偏好的語音關鍵字 (按優先順序排列)
            const preferredVoices = [
                'Online', // Edge 的高品質線上語音
                'Natural',// Edge 的高品質線上語音
                'Google US English', // Chrome 的高品質語音
                'Siri'    // Safari 的高品質語音
            ];

            let bestVoice = null;

            // 根據偏好清單尋找最佳語音
            for (const keyword of preferredVoices) {
                bestVoice = voices.find(voice => voice.lang === 'en-US' && voice.name.includes(keyword));
                if (bestVoice) break; // 找到就停止搜尋
            }

            // 如果沒有找到偏好的語音，就選擇第一個可用的美國英語語音作為備用
            if (!bestVoice) {
                bestVoice = voices.find(voice => voice.lang === 'en-US');
            }

            selectedVoice = bestVoice;
            if (selectedVoice) {
                console.log('Selected voice for Part 2:', selectedVoice.name);
            } else {
                console.log('No suitable English voice found for Part 2.');
            }
        }


        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            // 語音是異步載入的，需要這樣處理
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = selectBestVoice;
            }
            selectBestVoice(); // 嘗試立即選擇
            loadQuestion();
        });

        // Cancel speech if user navigates away or closes tab
        window.addEventListener('beforeunload', () => {
            if ('speechSynthesis' in window && isSpeaking) {
                window.speechSynthesis.cancel();
            }
        });
    </script>
</body>
</html>
